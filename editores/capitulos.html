<!DOCTYPE html>
<html lang='es'>

<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Island+Moments&family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
    <title>capítulo</title>
    <link rel='stylesheet' href='../style.css'>
</head>

<body class="page-escribir">
    <main class='editor'>
        <h2>escribir capítulo</h2>
        <div class='meta'>
            <span id="titulo"   class="ph" contenteditable="true" data-placeholder="título"></span>
            <span id="capitulo" class="ph" contenteditable="true" data-placeholder="capítulo"></span>
            <span id="libro"    class="ph" contenteditable="true" data-placeholder="libro"></span>
            <span id="fecha"    class="ph" contenteditable="true" data-placeholder="fecha" title="Click para elegir fecha"></span>
            <span id="hora"     class="ph" data-placeholder="hora" title="Click para elegir hora"></span>
        </div>
        <input type="date" id="fechaPicker" class="visualmente-hidden visually-hidden" aria-hidden="true" tabindex="-1" />
        <input type="time" id="horaPicker"  class="visualmente-hidden visually-hidden" aria-hidden="true" tabindex="-1" step="60" />
        <div class='box'>
            <div id='editor' contenteditable='true'></div>
        </div>
        <div class='toolbar' aria-label='Formato (capítulos)'>
            <button class='nav-btn' data-action='link'>link</button>
            <button class='nav-btn' data-tag='em'>cursiva</button>
        </div>
        <div class='actions'><a href='#' id='download'>descargar</a></div>
    </main>
    <script src="../js/editor-core.js"></script>
    <script>
      (function(){
        const $ = s => document.querySelector(s);
        // Bootstrap core (fields + toolbar); we'll override download to customize payload & filename
        SimpleEditor.init({
          root: document,
          editor: '#editor',
          toolbarBtnSel: '.toolbar .nav-btn',
          // do not wire download here; we attach a custom handler below
          fields: {
            titulo:   { default: '' },
            capitulo: { default: '' },
            libro:    { default: '' },
            fecha:    { picker: 'date', inputId: 'fechaPicker' },
            hora:     { picker: 'time', inputId: 'horaPicker' }
          }
        });

        // Custom download: filename [libro]_[capitulo]_[fecha-hora].html and content: <h3>titulo</h3> + editor HTML
        document.getElementById('download').addEventListener('click', function(e){
          e.preventDefault();
          const editor = $('#editor');
          const titulo = ($('#titulo')?.textContent || '').trim();
          const cap    = ($('#capitulo')?.textContent || '').trim().replace(/\s+/g,'_') || 'capitulo';
          const libro  = ($('#libro')?.textContent    || '').trim().replace(/\s+/g,'_') || 'libro';
          const fecha  = ($('#fecha')?.textContent    || '').trim();
          let   hora   = ($('#hora')?.textContent     || '').trim();
          // if hour invalid/empty, default to now and reflect in UI
          if (!/^\d{2}:\d{2}$/.test(hora)) {
            const now = new Date();
            hora = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const horaSpan = $('#hora');
            if (horaSpan) { horaSpan.textContent = hora; horaSpan.setAttribute('aria-label','hora '+hora); }
            const horaInput = $('#horaPicker'); if (horaInput) horaInput.value = hora;
          }
          const [hh,mm] = hora.split(':');

          const payload = `<h3>${titulo}</h3>\n${(editor.innerHTML||'').trim()}`;
          const blob = new Blob([payload], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${libro}_${cap}_${fecha}-${hh}-${mm}.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      })();
    </script>
</body>

</html>